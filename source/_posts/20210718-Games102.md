---
title: Games102
date: 2021/07/18
tags: 
- graphics
- course
categories:
- note
- grpahics
top: -1
keywords: graphics-games-geometry
---

# 函数拟合

## 函数空间

用若干简单函数（“基函数”）线性组合张成一个函数空间，空间中的函数用$L=span\{f_1, f_2, \cdots, f_n\} = \{\sum_{i=1}^n a_i f_i(x) | a_i \in R \}$​，此时函数就可以用n个体系数进行表达，即系数向量$(a_1, \cdots, a_n)$​​。

空间的完备性是指这个函数空间是否可以表示任意函数。

常用的两个函数空间是多项式函数空间和三角函数空间。

多项式空间的基是幂函数，$f(x)=\sum_{k=0}^n a_i x^k$，类似的是泰勒公式。

三角函数空间的基是三角函数，$f(x) = a_0 + \sum_{k=1}^n (a_k \cos kx + b_k \sin kx)$如傅里叶变换。

## 赋范空间

赋范空间是欧几里得空间的推广，将空间中距离使用范数替换。赋范空间=线性空间+范数

### 范数定义

范数是指在线性空间上的非负值运算$|| \cdot ||$，满足以下三个条件

1. 正定性：$||x|| \ge 0, \forall x \in X$​
2. 齐次性：$||a x|| = |a| \cdot ||x||, \forall x \in X, a \in F$
3. 三角不等式：$||x + y|| \le ||x|| + ||y||, \forall x, y \in X$

度量函数之间的距离为：$<f, g> = \int_a^b f(x)g(x) dx$

### 其他一些空间

赋范空间+完备性=巴拿赫空间

内积空间+完备性=希尔伯特空间

## 如何找到满足要求的函数

1. 选择函数空间
   1. 线性函数空间：多项式空间、RBF、三角函数空间
2. 度量哪个函数是好的
   1. 插值：函数经过每个数据点
   2. 逼近：函数尽量靠近数据点
3. 如何求解或优化

### 插值

插值的目标是找到一个函数，使得对所有的数据有$y_i = f(x_i), i = 0,\cdots, n$​。

求解方法

1. 联立求解线性方程组，
2. n次Langrange插值多项式

当系数矩阵条件数高时，有无穷解。

#### Lagrange插值函数

插值n+1个点，次数不超过n的多项式是存在且唯一的。第$i$个基函数为$l_i(x) = \prod_{k=0,k \neq j}^n \frac {x - x_i} {x_k - x_i}$，$l_i(x)$在$x_i$上为1 ，在$x_j, (j \neq i)$​为0。​

最终的函数是$f(x) = \sum_{i=0}^n y_i l_i(x)$​

插值函数的自由度=未知量个数-已知量个数。

#### Newton插值

一阶差商：$f[x_0, x_1] = \frac {f(x_1) - f(x_0)} {x_1 - x_0}$

k阶差商：$f[x_0, \cdots, x_k] = \frac {f[x_1, \cdots, x_k] - f[x_0, \cdots, x_k]} {x_k - x_0}$

Newton插值多项式为$f(x) = f(x_0) + f[x_0, x_1](x - x0) + \cdots + f[x_0, \cdots, x_n](x - x_{n-1})$​​

#### Bernstein多项式

对于$n$​阶的Bernstein多项式，第$i$个基函数为$B_i^{n}(x) = C^i_n x^i(1-x)^{n-i}$​。其中$x \in [0, 1]$

##### Bernstein基本性质

1. 正性，权性（大于等于0且和为1）
2. 递归定义：$B_{n,i}(x) = (1-x) B_{n-1, i}(x) + x B_{n-1, i-1}(x)$​​​​​​
3. $B_{n,i}$​在$\frac i n$​​处有最大值。
4. 基性，$B_{n}$​是次数不高于$n$​的多项式集合的一组基。
5. 端点插值，
6. 导数，$\frac {d}{dt} B_i^{n}(t) = n[B_{i-1}^{n-1}(t) - B_i^{n-1}(t)]$，$\frac {d^2} {dt^2} B_i^{n}(t) = n(n-1)[B_{i-1}^{n-2}(t) - 2B_{i-1}^{n-2}(t) + B_i^{n-2}(t)]$

#### 多项式插值的问题

1. 系数矩阵是稠密的。
2. 依赖于基函数的选取，矩阵可能是病态的，导致难于求解。
3. 输入数据的细微变化导致输出的剧烈变化，
4. 条件数随着数据点的数量呈指数级增长。
5. 出现震荡现象

##### 矩阵条件数

矩阵条件数等于最大特征值和最小特征值之间的比例，即$k_2(A) = \frac {\max_{x \neq 0} \frac {||Ax||} {||x||}} {\min_{x \neq 0} \frac {||Ax||} {||x||}}$​

条件数大意味着基元之间有太多的相关性。

#### 多项式基函数的优势

1. 易于计算，表现良好，光滑
2. 表达能力足够

#### 幂函数基的问题

1. 幂函数之间的差别随着次数增加而减小
2. 不同幂函数之间的唯一差别为增长速度

一般希望不同的基函数可以互相抵消，即系数正负交替。或者使用正交多项式基。

#### RBF径向基函数

RBF是一个取值仅依赖于到原点距离的实质函数。

RBF插值即在每个数据处有一个RBF函数，插值函数为这些RBF的线性组合。这种情况下，$\mu$为数据点，所有RBF$\sigma$​的一致，需要经验性设置，拟合的结果为$f(x) = c_0 + \sum_{i=1}^n c_i g_i(x)$​，其中$u_i$是第$i$个采样点$x_i$，$\sigma$一致，人为设置。

再进一步，希望可以优化$\mu$和$\sigma$，所有的高斯函数都可以通过平移和缩放转换为标准高斯函数，即$g(x) = \frac {1} {\sqrt{2 \pi}} e^{-\frac {(x-\mu)^2} {2 \sigma^2}} = \frac {1} {\sqrt{2 \pi}} e^{\frac 1 2 (\frac 1 a x - \frac \mu \sigma)^2} = g_{0,1}(ax + b)$

因此可以看做将数据进行线性变换后使用标准高斯函数进行组合，即$f(x) = w_0 + \sum_{i=1}^n w_i g_{0,1}(a_ix + b_i)$。

这就是神经网络网络，$a_i$​和$b_i$​是权值，$g_{0,1}$​是激活函数，多层神经网络就是多个拟合函数复合。

高斯函数的特征：拟局部性

### 逼近

目标是找到一个函数，使得$\min \sum_{i=0}^n (y_i - f(x_i))^2$

二维数据可以采样最小二乘法。高维数据数值求解。

# 参数曲线

## 二元函数的基函数构造

使用张量积形式，即用两个一元函数的基函数的相互乘积来定义。

张量积定义简单，但是随着维数的增加，基函数数量急剧增加，导致最终求解代价增加。

## 向量值函数

### 单变量向量值函数

$f:R^1 \to R^m$形式的函数，可以看成多个单变量函数，各个函数独立无关，一般会使用同样的基函数。

单变量向量值的几何解释是，一个实数$x \in R^1$映射到$m$​维空间的一个点，轨迹构成$m$为空间中的一个曲线。本质维度为1。

### 参数曲线

形式为$f: R^1 \to R^3/R^2$​。

一条曲线由一个变量参数$t$决定，参数$t$可以看成该曲线的时间变量，可灵活表达非函数型的曲线

### 参数曲面

形式为$f:R^2 \to R^3$​​。

一张曲面有两个参数$(u, v)$决定，可灵活表达非函数型的任意曲面

### 二维映射

形式为$f:R^2 \to R^2$。

可看做二维区域之间的映射，可应用于图像变形

### 三维映射

形式为$f: R^3 \to R^3$

表示三维体区域之间的映射，应用于体形变、体参数化。

### 低维投影

形式为$f:R^3 \to R^2$

从高维空间映射到低维空间。

降维一般有信息丢失，丢失信息大部分情况下不可逆，无法恢复。

当降维后的维度高于本质维度，存在可能不丢失信息且可逆的映射。但若降维后的维度低于本质维度，则必定会有信息丢失。

## 曲线拟合

给定平面上一系列点$(x_i, y_i)$​，拟合出一条参数曲线$\begin{cases} x = x(t) \\ y = x(t) \end{cases} \ \ t \in [0, 1]$​​

参数曲线的参数变为了$t$，需要为每一个点$(x_i, y_i)$找到一个参数$t_i$​，找到$t_i$就可以使用拟合的方法找到误差最小的拟合函数。

问题转换为如何找到$t_i$，将$(x_i, y_i)$转换为$t_i$是一个降维问题，因此$t_i$​​的选择方式会影响最终结果，这个过程称为参数化（高维数据找低维的本征参数）。点的参数化对曲线拟合影响很大，需要好的参数化。

### Equidistant Parameterization

均匀参数化，将$t$的定义域均匀划分，即$t_{i+1} - t_i = constant$​。

这个参数化没有考虑数据点的几何性质，数据点密度不同时，密集处和稀疏处点的参数$t_i$间隔相同，不能表达。

### Chordal Parameterization

弦长参数化，计算相邻点之间的弦长，相邻点的参数的差与弦长呈比例，即$t_{i+1} - t_i = c||k_{i+1} - k_i||$，其中$c$是总弦长的倒数。

### Centripetal Parameterization

$t_{i+1} - t_i = \sqrt {|| k_{i+1} - k_i||}$​

### Foley Parameterization

$t_{i+1} - t_{i} = ||k_{i+1} - k_i|| \cdot (1 + \frac 3 2 \frac {\hat{\alpha_i}||k_i - k_{i-1}||} {||k_i - k_{i-1}|| + ||k_{i+1} - k_i||} + \frac 3 2  \frac {\hat{\alpha_{i+1}}||k_{i+1} - k_i||} {||k_{i+1} - k_i|| + ||k_{i+2} - k_{i+1}||} )$​

其中$\hat{\alpha_i} = \min(\pi - \alpha_i, \frac \pi 2)$，$\alpha_i = angle(k_{i-1}, k_i, k_{i+1})$

# 三次样条函数

样条是具有一定弹性的软木条；压铁是用来固定样条所经过的点。

根据材料力学中的贝努利欧拉方程，有$M(x)=EIk(x)=EI \frac {y''(x)} {(1+(y'(x))^2)^\frac 3 2}$，其中$M(x)$是曲线弯矩，$E$是模样条的弹性模量，$I$是几何惯性矩，$k(x)$​是曲线的曲率。

由于样条曲线的弯曲程度通常不是很剧烈，通常增加一个小扰度假设，即$y'(x) \ll 1$，即弯角不大于$45^{\circ}$​。则$M(x)\approx EI y''(x)$

又因为两个压铁之间无外力，所以$M(x)$为一次式，即$M(x)=ax + b$

解得两压铁之间的曲线函数$y(x)$​为三次函数，所以样条曲线为分段三次函数。

## 定义

函数$S(x) \in C^2[a, b]$，且在每个小区间$[x_i, x_{i+1}]$上是三次多项式，其中$a=x_0 \lt x_1 \lt \cdots \lt x_n = b$是给定点，则称$S(x)$是节点$x_0, \cdots, x_n$上的三次样条函数，若在节点$x_i$上给定函数值$y_i = f(x_i)$并成立，则称$S(x)$为三次样条插值函数。

## 求解

有$n+1$个数据点的样条，共有$n$段三次函数，共需要求解$4n$个系数。因此需要$4n$个约束。

$S(x)$满足插值条件$S(x_i) = y_i$，有$n+1$个约束。

$S(x)$​在$[a,b]$​上二阶导数连续，则满足连续条件$S(x_i-0) = S(x_i+0)$、$S'(x_i - 0) = S(x_i + 0)$​​和$S''(x_i - 0)=S''(x_i + 0)$，有$3n-3$个体条件。

总共有$4n-2$个条件，还需要$2$个约束条件。通常是在区间端点$a=x_0,b=x_n$处各加一个条件。根据实际问题的要求，常见的问题有以下三种

1. 已知两端的一阶导数，即$S'(x_0)=f'_0, S'(x_n)=f'_n$
2. 已知两端的二阶导数，即$S''(x_0)=f''_0, S''(x_n)=f''_n$
3. 当要求$S(x)$是以$x_n-x_0$为周期的函数时，则边界应满足$S(x_0 + 0) = S(x_n-0)$、$S'(x_0+0) = S'(x_n-0)$、$S''(x_0 + 0) = S''(x_n - 0)$

### 三弯矩方程

假设$M_i = S''_i(x_i)$​，则由于$S_i(x)$是三次多项式，因此，二阶阶导数是线性函数，即$S''_i(x) = \frac {M_i} {h_i} (x_{i+1} - x) + \frac {M_{i+1}} {h_i} (x - x_i)$​​​（根据拉格朗日插值公式可得）。

将$S''_i(x)$​​进行两次积分，可得$S_i(x) = \frac {M_i} {6 h_i} (x_{i+1} - x)^3 + \frac {M_{i+1}} {h_i} (x - x_i)^3 + C(x - x_i) + D(x_{i+1} - x)$​

将插值条件$S_i(x_i) = y_i$和$S_{i+1}(x_{i+1}) = y_{i+1}$可解得C和D，即$S_i(x) = \frac {M_i} {6 h_i} (x_{i+1} - x)^3 + \frac {M_{i+1}} {h_i} (x - x_i)^3 + (\frac {y_{i+1}} {h_i} - \frac {M_{i+1} h_i} {6})(x - x_i) + (\frac {y_i} {h_i} - \frac {M_i h_i} {6})D(x_{i+1} - x)$​

对上式求微分可得$S'_i(x) = - \frac {h_i} 3 M_i - \frac {h_i} 6 M_{i+1} - \frac {y_i} {h_i} + \frac {y_{i+1}} {h_i}$

由$C^1$连续，可知$S'_i(x_i) = S'_{i-1}(x_i)$

取$M_0 = M_n = 0$，并联立所有方程组可得

$\begin{pmatrix} u_1 & h_1 \\ h_1 & u_2 & h_2 \\ & \ddots & \ddots & \ddots \\ & & h_{n-3} & u_{n-2} & h_{n-2} \\ & & & h_{n-2} & u_{n-1} \end{pmatrix} \begin{pmatrix} M_1 \\ M2 \\ \vdots \\ M_{n-2} \\ M_{n-1} \end{pmatrix} = \begin{pmatrix} v_1 \\ v_2 \\ \vdots \\ v_{n-2} \\ v_{n-1} \end{pmatrix}$​

其中$h_i = x_{i+1} - x_i$，$u_i = 2(h_i + h_{i-1})$，$b_i = \frac 6 {h_i} (y_{i+1} - y_i)$，$v_i = b_i - b_{i-1}$

### 三转角方程

假设节点的$1$阶导数为$M_i$

### 样条函数的局限性

1. 有小扰度假设
2. 不能处理多只问题
3. 不能很好表达空间曲线
4. 不具有坐标不变性

### Hermite插值

Hermite插值除了要求在插值点数的值相同，还要求在插值点的一阶到指定阶的函数值相同。

# 曲线的几何连续性

## 参数连续性的不足

1. 参数连续性过于严格，在几何设计中不直观
2. 连续性依赖于选择的参数，同一条曲线，选择的参数不同，连续性不一样。

问题的本质在于到处是对参数的求导，当引入了一个参数变换时，导数也会发生变化，因此连续性会依赖参数。

## 几何连续性

设$\phi(t)(a \le t \le b)$是给定曲线，若存在一个参数变换$t=\rho(s)(a_1 \le s \le b_1)$，使得$\phi(\rho(s))\in C^n[a_1, b_1]$，且$\frac {d\phi(\rho(s))} {ds} \neq 0$，则称曲线$\phi(t)(a \le t \le b)$是$n$阶集合连续的曲线，即为$\phi(t) \in GC^n[a, b]$或$\phi(t) \in G^n[a, b]$

### 性质

1. 曲线上无奇点
2. 几何连续性与参数选取无关，是曲线本身固有的几何性质。
3. $G^n$的条件比$C^n宽，曲线类型更多。

### 常用形式

$G^0$​：表示两个曲线有公共点，与$C^0$一致

$G^1$：两曲线在连接点处有公共的切线，即切线方向连续

$G^2$：两曲线在连接点处有公共的曲率圆，即曲率连续

# Bezier曲线

当使用幂基来表达曲线时，二次多项式曲线的参数表达为$f(t)=at^2 + bt + c$

另一种几何观点时，将系数作为顶点，基函数作为系数，则可以将曲线看做定点的组合，此时顶点和曲线没有直观的联系，不利于用户交互修改曲线，不利于设计。

当使用Bernstein基函数进行改写之后，增加了曲线和顶点的关系，曲线位于顶点所围城的凸包内，因此更加直观，有利于设计。Bezier曲线就是以Bernstein作为基函数。

$n$​次Bezier曲线有$n+1$个控制顶点，按顺序连接起来则称为控制多边形。

Bezier曲线的性质来源于Bernstein基函数的性质。使用其他基函数可以生成其他曲线。

## 导数

$f(t) = \sum_{i=0}^n B^n_i(t) p_i$

$f'(t) = n \sum_{i=0}^{n-1}B_i^{n-1}(t)(p_{i+1} - p_i)$

$f^r(t) = \frac {n!} {(n-r)!} \sum_{i=0}^{n-r} B_i^{n-r}(t) \Delta^r p_i$​​

## 端点性质

+ 端点插值$f(0)=p_0$，$f(1) = p_n$
+ 端点的切线方向与边相同，$f'(0) = n(p_1 - p_0)$，$f'(1) = n(p_n - p_{n-1})$
+ 端点的$2$阶切线与$3$点相关，$f''(0) = n(n-1)(p_2 - 2p_1 + p_0)$，$f''(1) = n(n-1) (p_n - 2 p_{n-1} + p_{n-2})$

## Bezier曲线的问题

1. 全局性，牵一发而动全身，不利于设计，原因在于基函数是全局的

# B样条

Bezier曲线具有全局性，通常设计时使用分段的Bezier曲线来表示，每段曲线的改变不会改变全部的曲线，至多改变相邻的几个曲线。

曲线的分段表达使得曲线具有局部性，但是需要使用多个函数来表达，那么有没有一种方式统一表达？

## 样条曲线的统一表达

Bezier曲线的几何观点是，将曲线看做是每个控制顶点使用基函数进行组合。因此基函数需要由以下性质

+ 局部性，使最终曲线具有局部性。
+ 正性和权性，使最终曲线具有凸包性。

## B样条的定义

节点向量：控制点进行参数化后得到的参数向量。基函数通过节点向量定义的，定义在相邻的节点向量中。

k阶均匀B样条的基函数是

$N_{i}^1(t) = \begin{cases} 1,\ if \ i \le t \lt i+1 \\ 0,\ otherwise \end{cases}$

$N_i^k(t) = \frac {t-i} {(i+k-1)-i}N_i^{k-1}(t) + \frac {(i+k) - t} {(i+k) - (i+1)}N_{i+1}^{k-1}(t) = \frac {t-i}{k-1} N_i^{k-1}(t) + \frac {i+k-t}{k-1}N_{i+1}^{k-1}(t)$

均匀是指控制点使用均匀参数化



给定节点向量，k阶非均匀B样条的基函数定义为

$N_{i}^1(t) = \begin{cases} 1,\ if \ t_i \le t \lt t_{i+1} \\ 0,\ otherwise \end{cases}$

$N_i^k(t) = \frac {t - t_i} {t_{i+k-1} - t_{i}}N_i^{k-1}(t) + \frac {t_{i+k}-t} {t_{i+k} - t_{i+1}} N_{i+1}^{k-1}(t)$

两个系数的分母是$N_i^{i-1}$和$N_{i+1}^{k-1}$的非零区间长度，前面的分子是参数$t$到区间开始的长度，后面的参数是区间结尾到参数$t$的长度。

k阶的曲线，有k+1个控制顶点。

那么对于1阶曲线，有2个控制点$t_0$和$t_1$，$N_1^0(t)$的范围是$[0,1)$，而$N_1^1(t)$的范围是$[1, 2)$，对于第$i$个控制顶点，系数是第$i$个基函数。



给定$n+1$个控制点$d_0, \cdots, d_n \in \mathbb{R}^3$，参数化得到节点向量$T=(t_0, \cdots, t_n, \cdots, t_{n+k})$，则$k$阶B样条曲线为$x(t)=\sum_{i=0}^n N_i^k(t) \cdot d_i$

## B样条性质

+ $N_i^k(t) > 0$的定义域为$t \in [i, i+k)$
+ 对于$t \in [t_i, t_{i+k}]$，基函数$N_i^{k}(t)$是$C^{k-2}$连续的，所有通常贝塞尔曲线用三阶。
+ 若有两个控制点节点重合，则对应曲线的光滑降1阶，因此可以通过重合控制点来控制曲线的光滑性。
+ 若需要首末端点需要插值，则首尾重合的节点数量需要相同，降维Bezier曲线。

